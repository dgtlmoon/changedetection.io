# Fly.io Configuration for TicketWatch
# Deploy with: fly deploy --config tasks/fly.toml
#
# Prerequisites:
# 1. Install flyctl: https://fly.io/docs/hands-on/install-flyctl/
# 2. Login: fly auth login
# 3. Create volume: fly volumes create ticketwatch_data --region ord --size 1
# 4. Set secrets (see FLY_SECRETS_SETUP.md for detailed instructions):
#
#    Required:
#    fly secrets set DATABASE_URL="postgresql://user:pass@host/db?sslmode=require"
#    fly secrets set SLACK_WEBHOOK_URL="https://hooks.slack.com/services/..."
#
#    Optional:
#    fly secrets set PROXY_LIST_PATH="/datastore/proxies.txt"
#    fly secrets set SALTED_PASS="sha256-hash-of-password"
#
# 5. Deploy: fly deploy --config tasks/fly.toml

app = "changedetection-io-z08mj"
primary_region = "ord"

[build]
  dockerfile = "Dockerfile"
  # Build context is the parent directory (project root)

[env]
  PORT = "5000"
  LISTEN_HOST = "0.0.0.0"
  FETCH_WORKERS = "5"
  PLAYWRIGHT_BROWSERS_PATH = "/ms-playwright"
  # Reduce memory usage for Playwright
  PLAYWRIGHT_CHROMIUM_SANDBOX = "false"

[http_service]
  internal_port = 5000
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]

  [http_service.concurrency]
    type = "connections"
    hard_limit = 25
    soft_limit = 20

[[http_service.checks]]
  grace_period = "60s"
  interval = "30s"
  method = "GET"
  timeout = "10s"
  path = "/"

# Persistent volume for datastore
# Create with: fly volumes create ticketwatch_data --region ord --size 1
[[mounts]]
  source = "ticketwatch_data"
  destination = "/datastore"
  initial_size = "1gb"

[[vm]]
  size = "shared-cpu-2x"
  memory = "2048mb"
