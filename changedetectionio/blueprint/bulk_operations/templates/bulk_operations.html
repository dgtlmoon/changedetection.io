{% extends 'base.html' %}
{% block content %}
{% from '_helpers.html' import render_field %}
<script src="{{url_for('static_content', group='js', filename='tabs.js')}}" defer></script>
<script src="{{url_for('static_content', group='js', filename='modal.js')}}"></script>

<style>
.bulk-ops-container {
    max-width: 900px;
    margin: 0 auto;
}
.bulk-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.bulk-stat {
    background: var(--color-background-alt, #f5f5f5);
    padding: 15px 25px;
    border-radius: 8px;
    text-align: center;
}
.bulk-stat .number {
    font-size: 2em;
    font-weight: bold;
    color: var(--color-primary, #1db954);
}
.bulk-stat .label {
    font-size: 0.9em;
    color: var(--color-text-muted, #666);
}
.csv-info {
    background: var(--color-background-alt, #f0f7ff);
    border: 1px solid var(--color-border, #d0e3f7);
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
}
.csv-info h4 {
    margin-top: 0;
    color: var(--color-text, #333);
}
.csv-info code {
    background: var(--color-background, #fff);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
}
.export-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}
.progress-container {
    display: none;
    margin: 20px 0;
    padding: 15px;
    background: var(--color-background-alt, #f5f5f5);
    border-radius: 8px;
}
.progress-bar {
    height: 20px;
    background: var(--color-background, #e0e0e0);
    border-radius: 10px;
    overflow: hidden;
}
.progress-bar-fill {
    height: 100%;
    background: var(--color-primary, #1db954);
    width: 0%;
    transition: width 0.3s ease;
}
.progress-text {
    margin-top: 10px;
    text-align: center;
    color: var(--color-text-muted, #666);
}
.file-input-wrapper {
    margin: 15px 0;
}
.file-input-wrapper input[type="file"] {
    padding: 10px;
    border: 2px dashed var(--color-border, #ccc);
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
}
.template-download {
    margin-top: 10px;
}
.template-download a {
    color: var(--color-primary, #1db954);
    text-decoration: none;
}
.template-download a:hover {
    text-decoration: underline;
}

html[data-darkmode="true"] .bulk-stat {
    background: var(--color-background-darker, #2a2a2a);
}
html[data-darkmode="true"] .csv-info {
    background: var(--color-background-darker, #1a2530);
    border-color: var(--color-border-dark, #3a4a5a);
}
html[data-darkmode="true"] .csv-info code {
    background: var(--color-background, #1a1a1a);
}
</style>

<div class="bulk-ops-container">
    <h2>{{ _('Bulk Operations') }}</h2>

    <div class="bulk-stats">
        <div class="bulk-stat">
            <div class="number">{{ total_watches }}</div>
            <div class="label">{{ _('Total Events') }}</div>
        </div>
        <div class="bulk-stat">
            <div class="number">{{ tags|length }}</div>
            <div class="label">{{ _('Tags') }}</div>
        </div>
    </div>

    <div class="tabs collapsable">
        <ul>
            <li class="tab active"><a href="#import-csv">{{ _('Import CSV') }}</a></li>
            <li class="tab"><a href="#export-csv">{{ _('Export CSV') }}</a></li>
        </ul>
    </div>

    <div class="box-wrap inner">
        <!-- Import CSV Tab -->
        <div class="tab-pane-inner" id="import-csv">
            <h3>{{ _('Import Events from CSV') }}</h3>

            <div class="csv-info">
                <h4>{{ _('CSV Format') }}</h4>
                <p>{{ _('Your CSV file should have a header row with the following columns:') }}</p>
                <p>
                    <code>url</code> ({{ _('required') }}),
                    <code>tags</code>,
                    <code>event_name</code>,
                    <code>artist</code>,
                    <code>venue</code>,
                    <code>event_date</code>,
                    <code>event_time</code>,
                    <code>processor</code>
                </p>
                <p><strong>{{ _('Note:') }}</strong> {{ _('Tags should be comma-separated within the cell.') }}</p>
            </div>

            <form action="{{ url_for('bulk_operations.import_events_csv') }}" method="POST" enctype="multipart/form-data" id="import-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="file-input-wrapper">
                    <label for="csv_file">{{ _('Select CSV file:') }}</label>
                    <input type="file" name="csv_file" id="csv_file" accept=".csv" required>
                </div>

                <div class="template-download">
                    <a href="{{ url_for('bulk_operations.download_csv_template') }}">
                        <i data-feather="download" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                        {{ _('Download CSV template') }}
                    </a>
                </div>

                <div class="progress-container" id="import-progress">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="import-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="import-progress-text">{{ _('Processing...') }}</div>
                </div>

                <div style="margin-top: 20px;">
                    <button type="submit" class="pure-button pure-button-primary" id="import-btn">
                        <i data-feather="upload" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 5px;"></i>
                        {{ _('Import Events') }}
                    </button>
                </div>
            </form>
        </div>

        <!-- Export CSV Tab -->
        <div class="tab-pane-inner" id="export-csv" style="display: none;">
            <h3>{{ _('Export Events to CSV') }}</h3>

            <div class="csv-info">
                <h4>{{ _('Export Options') }}</h4>
                <p>{{ _('Export all your events to a CSV file for backup or transfer to another system.') }}</p>
                <p>{{ _('The export includes: URL, tags, event name, artist, venue, event date, event time, processor, last checked, last changed, and pause status.') }}</p>
            </div>

            <div class="export-buttons">
                <a href="{{ url_for('bulk_operations.export_events_csv') }}" class="pure-button pure-button-primary">
                    <i data-feather="download" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 5px;"></i>
                    {{ _('Export All Events') }}
                </a>
            </div>

            <p style="margin-top: 20px; color: var(--color-text-muted, #666);">
                {{ _('Tip: You can also export selected events from the main watch list by selecting them with checkboxes and using the Export button.') }}
            </p>
        </div>
    </div>

    <div style="margin-top: 30px;">
        <a href="{{ url_for('watchlist.index') }}" class="pure-button button-secondary">
            <i data-feather="arrow-left" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 5px;"></i>
            {{ _('Back to Watch List') }}
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();

    // Show progress indicator on form submit
    document.getElementById('import-form').addEventListener('submit', function() {
        document.getElementById('import-progress').style.display = 'block';
        document.getElementById('import-btn').disabled = true;
        document.getElementById('import-btn').textContent = '{{ _("Importing...") }}';

        // Animate progress bar (indeterminate)
        var fill = document.getElementById('import-progress-fill');
        fill.style.width = '100%';
        fill.style.transition = 'none';
        fill.style.background = 'linear-gradient(90deg, var(--color-primary, #1db954) 0%, var(--color-background, #e0e0e0) 50%, var(--color-primary, #1db954) 100%)';
        fill.style.backgroundSize = '200% 100%';
        fill.style.animation = 'progress-indeterminate 1.5s ease-in-out infinite';
    });
});
</script>

<style>
@keyframes progress-indeterminate {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>

{% endblock %}
