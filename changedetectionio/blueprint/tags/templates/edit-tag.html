{% extends 'base.html' %}
{% block content %}
{% from '_helpers.html' import render_field, render_checkbox_field, render_button, render_ternary_field %}
{% from '_common_fields.html' import render_common_settings_form %}
<script>
    const notification_base_url="{{url_for('ui.ui_notification.ajax_callback_send_notification_test', mode="group-settings")}}";
    const slack_webhook_test_url="{{url_for('tags.test_slack_webhook', uuid=data.uuid)}}";
</script>

<script src="{{url_for('static_content', group='js', filename='tabs.js')}}" defer></script>
<script>

/*{% if emailprefix %}*/
    /*const email_notification_prefix=JSON.parse('{{ emailprefix|tojson }}');*/
/*{% endif %}*/

{% set has_tag_filters_extra='' %}

</script>

<script src="{{url_for('static_content', group='js', filename='watch-settings.js')}}" defer></script>
<script src="{{url_for('static_content', group='js', filename='notifications.js')}}" defer></script>
<script src="{{url_for('static_content', group='js', filename='slack-webhook.js')}}" defer></script>

<style>
    .webhook-url-display {
        font-family: monospace;
        background: var(--color-background-code);
        padding: 0.5em;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 0.5em;
    }
    .webhook-url-masked {
        color: var(--color-grey-500);
    }
    .webhook-url-visible {
        color: var(--color-text);
    }
    .slack-webhook-section {
        border: 1px solid var(--color-border-notification);
        padding: 1rem;
        border-radius: 5px;
        margin-bottom: 1rem;
    }
    .slack-webhook-section h4 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--color-text);
    }
    #slack-test-result {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 4px;
        display: none;
    }
    #slack-test-result.success {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid #10b981;
        color: #10b981;
    }
    #slack-test-result.error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid #ef4444;
        color: #ef4444;
    }
    .tag-color-preview {
        display: inline-block;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        vertical-align: middle;
        margin-left: 0.5em;
        border: 1px solid var(--color-border-input);
    }
    .color-picker-wrapper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .color-picker-wrapper input[type="color"] {
        width: 50px;
        height: 35px;
        padding: 0;
        border: 1px solid var(--color-border-input);
        border-radius: 4px;
        cursor: pointer;
    }
</style>

<div class="edit-form monospaced-textarea">

    <div class="tabs collapsable">
        <ul>
            <li class="tab" id=""><a href="#general">{{ _('General') }}</a></li>
            <li class="tab"><a href="#slack-webhook">{{ _('Slack Webhook') }}</a></li>
            <li class="tab"><a href="#filters-and-triggers">{{ _('Filters & Triggers') }}</a></li>
            {% if extra_tab_content %}
            <li class="tab"><a href="#extras_tab">{{ extra_tab_content }}</a></li>
            {% endif %}
            <li class="tab"><a href="#notifications">{{ _('Notifications') }}</a></li>
        </ul>
    </div>

    <div class="box-wrap inner">
        <form class="pure-form pure-form-stacked"
              action="{{ url_for('tags.form_tag_edit', uuid=data.uuid) }}" method="POST">
             <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="tab-pane-inner" id="general">
                <fieldset>
                    <div class="pure-control-group">
                        {{ render_field(form.title, placeholder="Tag name", required=true, class="m-d") }}
                    </div>
                    <div class="pure-control-group">
                        <label for="tag_color">{{ _('Tag Color') }}</label>
                        <div class="color-picker-wrapper">
                            <input type="color"
                                   id="tag_color"
                                   name="tag_color"
                                   value="{{ data.tag_color or '#3B82F6' }}"
                                   class="tag-color-picker">
                            <span class="pure-form-message-inline">{{ _('Choose a color for UI organization') }}</span>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="tab-pane-inner" id="slack-webhook">
                <fieldset>
                    <div class="slack-webhook-section">
                        <h4>{{ _('Slack Webhook Configuration') }}</h4>
                        <p class="pure-form-message-inline" style="margin-bottom: 1rem;">
                            {{ _('Configure a Slack webhook URL to route notifications for this tag to a specific Slack channel.') }}
                        </p>

                        <div class="pure-control-group">
                            <label for="slack_webhook_url">{{ _('Slack Webhook URL') }}</label>
                            {% if data.slack_webhook_url %}
                            <div class="webhook-url-display">
                                <span class="webhook-url-masked">{{ 'â€¢' * 50 }}</span><span class="webhook-url-visible">{{ data.slack_webhook_url[-8:] if data.slack_webhook_url else '' }}</span>
                            </div>
                            <br>
                            {% endif %}
                            <input type="text"
                                   id="slack_webhook_url"
                                   name="slack_webhook_url"
                                   value="{{ data.slack_webhook_url or '' }}"
                                   placeholder="https://hooks.slack.com/services/T.../B.../..."
                                   class="m-d slack-webhook-url">
                            <span class="pure-form-message-inline">
                                {{ _('Get your webhook URL from') }} <a href="https://api.slack.com/messaging/webhooks" target="_blank">{{ _('Slack API') }}</a>
                            </span>
                            {% if form.slack_webhook_url.errors %}
                            <ul class="errors">
                                {% for error in form.slack_webhook_url.errors %}
                                <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>

                        <div class="pure-control-group">
                            {{ render_checkbox_field(form.slack_notification_muted) }}
                            <span class="pure-form-message-inline">
                                {{ _('When enabled, Slack notifications will be suppressed for this tag') }}
                            </span>
                        </div>

                        <div class="pure-control-group">
                            <button type="button"
                                    id="test-slack-webhook"
                                    class="pure-button button-secondary">
                                <span class="spinner" style="display: none;"></span>
                                {{ _('Test Webhook') }}
                            </button>
                            <span class="pure-form-message-inline">
                                {{ _('Send a test message to verify your webhook configuration') }}
                            </span>
                        </div>

                        <div id="slack-test-result">
                            <span id="slack-test-message"></span>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="tab-pane-inner" id="filters-and-triggers">
                <p>{{ _('These settings are') }} <strong><i>{{ _('added') }}</i></strong> {{ _('to any existing watch configurations.') }}</p>
                {% include "edit/include_subtract.html" %}
                <div class="text-filtering border-fieldset">
                    <h3>{{ _('Text filtering') }}</h3>
                    {% include "edit/text-options.html" %}
                </div>
            </div>

        {# rendered sub Template #}
        {% if extra_form_content %}
            <div class="tab-pane-inner" id="extras_tab">
            {{ extra_form_content|safe }}
            </div>
        {% endif %}
            <div class="tab-pane-inner" id="notifications">
                <fieldset>
                    <div  class="pure-control-group inline-radio">
                      {{ render_ternary_field(form.notification_muted, BooleanField=True) }}
                    </div>
                    {% if 1 %}
                    <div class="pure-control-group inline-radio">
                      {{ render_checkbox_field(form.notification_screenshot) }}
                        <span class="pure-form-message-inline">
                            <strong>{{ _('Use with caution!') }}</strong> {{ _('This will easily fill up your email storage quota or flood other storages.') }}
                        </span>
                    </div>
                    {% endif %}
                    <div class="field-group" id="notification-field-group">
                        {% if has_default_notification_urls %}
                        <div class="inline-warning">
                            <img class="inline-warning-icon" src="{{url_for('static_content', group='images', filename='notice.svg')}}" alt="{{ _('Look out!') }}" title="{{ _('Lookout!') }}" >
                            {{ _('There are') }} <a href="{{ url_for('settings.settings_page')}}#notifications">{{ _('system-wide notification URLs enabled') }}</a>, {{ _('this form will override notification settings for this watch only') }} &dash; {{ _('an empty Notification URL list here will still send notifications.') }}
                        </div>
                        {% endif %}
                        <a href="#notifications" id="notification-setting-reset-to-default" class="pure-button button-xsmall" style="right: 20px; top: 20px; position: absolute; background-color: #5f42dd; border-radius: 4px; font-size: 70%; color: #fff">{{ _('Use system defaults') }}</a>

                        {{ render_common_settings_form(form, emailprefix, settings_application, extra_notification_token_placeholder_info) }}
                    </div>
                </fieldset>
            </div>

            <div id="actions">
                <div class="pure-control-group">
                    {{ render_button(form.save_button) }}
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}
