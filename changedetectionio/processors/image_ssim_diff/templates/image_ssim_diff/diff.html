{% extends 'base.html' %}
{% from '_helpers.html' import render_field, render_checkbox_field, render_button %}
{% block content %}

<style>
.comparison-score {
    padding: 1em;
    background: #f5f5f5;
    border-radius: 4px;
    margin: 1em 0;
    border: 1px solid #ddd;
}

.change-detected {
    color: #d32f2f;
    font-weight: bold;
}

.no-change {
    color: #388e3c;
    font-weight: bold;
}

.comparison-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5em;
    margin: 2em 0;
}

/* Interactive Image Comparison Slider */
.image-comparison {
    position: relative;
    width: 100%;
    overflow: hidden;
    border: 1px solid #ddd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    user-select: none;
}

.image-comparison img {
    display: block;
    width: 100%;
    height: auto;
    max-width: 100%;
    border: none;
    box-shadow: none;
}

.comparison-after {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    clip-path: inset(0 0 0 50%);
}

.comparison-slider {
    position: absolute;
    top: 0;
    left: 50%;
    width: 4px;
    height: 100%;
    background: #0078e7;
    cursor: ew-resize;
    transform: translateX(-2px);
    z-index: 10;
}

.comparison-handle {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 48px;
    height: 48px;
    background: #0078e7;
    border: 3px solid white;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: ew-resize;
    transition: top 0.1s ease-out;
}

.comparison-handle::after {
    content: '⇄';
    color: white;
    font-size: 24px;
    font-weight: bold;
    pointer-events: none;
}

.comparison-labels {
    position: absolute;
    top: 10px;
    width: 100%;
    display: flex;
    justify-content: space-between;
    padding: 0 0px;
    z-index: 5;
    pointer-events: none;
}

.comparison-label {
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 0.5em 1em;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: bold;
}

.screenshot-panel {
    text-align: center;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 1em;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.screenshot-panel h3 {
    margin: 0 0 1em 0;
    font-size: 1.1em;
    color: #333;
    border-bottom: 2px solid #0078e7;
    padding-bottom: 0.5em;
}

.screenshot-panel.diff h3 {
    border-bottom-color: #d32f2f;
}

.screenshot-panel img {
    max-width: 100%;
    height: auto;
    border: 1px solid #ddd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.version-selector {
    display: inline-block;
    margin: 0 0.5em;
}

.version-selector label {
    font-weight: bold;
    margin-right: 0.5em;
}

@media (max-width: 1200px) {
    .comparison-grid {
        grid-template-columns: 1fr;
    }
}

#settings {
    background: #fff;
    padding: 1.5em;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    margin-bottom: 2em;
}

.diff-fieldset {
    border: none;
    padding: 0;
    margin: 0;
}

.edit-link {
    float: right;
    margin-top: -0.5em;
}
</style>

<div id="settings">
    <a href="{{ url_for('ui.ui_edit.edit_page', uuid=uuid, next='diff') }}" class="pure-button button-small edit-link">
        <img style="height: 1em;display:inline-block;" src="{{url_for('static_content', group='images', filename='spread_the_word.svg')}}" alt="Edit" />
        Edit Watch
    </a>

    <form class="pure-form" action="{{ url_for('ui.ui_diff.diff_history_page', uuid=uuid) }}" method="GET" id="diff-form">
        <fieldset class="diff-fieldset">
            <h2 style="margin-top: 0;">Screenshot Comparison (Fast)</h2>

            {% if versions|length >= 2 %}
                <div class="version-selector">
                    <label for="diff-from-version">From:</label>
                    <select id="diff-from-version" name="from_version" class="needs-localtime" onchange="this.form.submit()">
                        {%- for version in versions|reverse -%}
                            <option value="{{ version }}" {% if version== from_version %} selected="" {% endif %}>
                                {{ version }}
                            </option>
                        {%- endfor -%}
                    </select>
                </div>

                <div class="version-selector">
                    <label for="diff-to-version">To:</label>
                    <select id="diff-to-version" name="to_version" class="needs-localtime" onchange="this.form.submit()">
                        {%- for version in versions|reverse -%}
                            <option value="{{ version }}" {% if version== to_version %} selected="" {% endif %}>
                                {{ version }}
                            </option>
                        {%- endfor -%}
                    </select>
                </div>
            {% endif %}

            <!-- Comparison score display -->
            <div class="comparison-score">
                <strong>Change Detection:</strong> {{ "%.2f"|format(change_percentage) }}% of pixels changed
                <br>
                {% if change_percentage > 0.1 %}
                    <span class="change-detected">⚠ Change Detected</span>
                {% else %}
                    <span class="no-change">✓ No Significant Change</span>
                {% endif %}
            </div>
        </fieldset>
    </form>
</div>

<div id="screenshot-comparison">
    <!-- Two-panel layout: Interactive slider + Static diff -->
    <div class="comparison-grid">
        <!-- Panel 1: Interactive Comparison Slider (Previous ↔ Current) -->
        <div class="screenshot-panel">
            <h3>Interactive Comparison</h3>
            <div style="color: #666; font-size: 0.9em; margin-bottom: 1em;">
                Drag slider to compare Previous ({{ from_version|format_timestamp_timeago }})
                vs Current ({{ to_version|format_timestamp_timeago }})
            </div>
            <div style="text-align: center; margin-bottom: 0.5em; display: flex; justify-content: center; gap: 1em;">
                <a href="#" onclick="downloadImage('img-before', '{{ from_version }}'); return false;" style="color: #0078e7; text-decoration: none; display: inline-flex; align-items: center; gap: 0.3em; font-size: 0.85em;" title="Download previous snapshot">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;">
                        <path d="M8 12L3 7h3V1h4v6h3z"/>
                        <path d="M1 14h14v2H1z"/>
                    </svg>
                    Previous
                </a>
                <a href="#" onclick="downloadImage('img-after', '{{ to_version }}'); return false;" style="color: #0078e7; text-decoration: none; display: inline-flex; align-items: center; gap: 0.3em; font-size: 0.85em;" title="Download current snapshot">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;">
                        <path d="M8 12L3 7h3V1h4v6h3z"/>
                        <path d="M1 14h14v2H1z"/>
                    </svg>
                    Current
                </a>
            </div>

            <div class="image-comparison" id="comparison-container">
                <!-- Before image (Previous snapshot) -->
                <img id="img-before" src="data:image/png;base64,{{ img_from_b64 }}" alt="Previous screenshot">

                <!-- After image (Current snapshot) -->
                <img class="comparison-after" id="img-after" src="data:image/png;base64,{{ img_to_b64 }}" alt="Current screenshot">

                <!-- Labels -->
                <div class="comparison-labels">
                    <span class="comparison-label">Previous</span>
                    <span class="comparison-label">Current</span>
                </div>

                <!-- Draggable slider -->
                <div class="comparison-slider" id="comparison-slider">
                    <div class="comparison-handle"></div>
                </div>
            </div>
        </div>

        <!-- Panel 2: Difference Visualization (Static) -->
        <div class="screenshot-panel diff">
            <h3>Difference Visualization</h3>
            <div style="color: #d32f2f; font-size: 0.9em; margin-bottom: 1em; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 1em;">
                <span>Red = Changed Pixels</span>
            </div>
            <div style="text-align: center; margin-bottom: 0.5em;">
                <a href="#" onclick="downloadImage('diff-image', '{{ to_version }}_diff'); return false;" style="color: #0078e7; text-decoration: none; display: inline-flex; align-items: center; gap: 0.3em; font-size: 0.85em;" title="Download difference image">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;">
                        <path d="M8 12L3 7h3V1h4v6h3z"/>
                        <path d="M1 14h14v2H1z"/>
                    </svg>
                    Download
                </a>
            </div>
            <img id="diff-image" src="data:image/jpeg;base64,{{ diff_image_b64 }}" alt="Difference visualization with red highlights">
        </div>
    </div>

    {% if comparison_data and comparison_data.get('history') and comparison_data.history|length > 1 %}
    <div style="margin-top: 3em; padding: 1em; background: #fff; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <h3>Comparison History</h3>
        <p style="color: #666; font-size: 0.9em;">Recent comparison results (last {{ comparison_data.history|length }} checks)</p>
        <div style="overflow-x: auto;">
            <table class="pure-table pure-table-striped" style="width: 100%;">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Change %</th>
                        <th>Method</th>
                        <th>Changed?</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in comparison_data.history|reverse %}
                    <tr>
                        <td>{{ entry.timestamp|format_timestamp_timeago }}</td>
                        <td>{{ "%.2f"|format(entry.change_percentage) }}%</td>
                        <td>{{ entry.method }}</td>
                        <td>
                            {% if entry.changed %}
                                <span style="color: #d32f2f; font-weight: bold;">Yes</span>
                            {% else %}
                                <span style="color: #388e3c;">No</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
function downloadImage(imageId, filename) {
    // Get the image element
    const img = document.getElementById(imageId);
    const base64Data = img.src;

    // Convert base64 to blob
    const byteString = atob(base64Data.split(',')[1]);
    const mimeString = base64Data.split(',')[0].split(':')[1].split(';')[0];

    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }

    const blob = new Blob([ab], { type: mimeString });

    // Determine file extension from MIME type
    const extension = mimeString.includes('jpeg') ? '.jpeg' : '.png';

    // Create download link
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename + extension;
    document.body.appendChild(a);
    a.click();

    // Cleanup
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 100);
}
</script>

<script src="{{ url_for('static_content', group='js', filename='comparison-slider.js') }}" defer></script>

{% endblock %}
